# .github/workflows/build-deploy.yml
name: Build & Deploy Battleship Game

on:
  push:
    branches: [ main ]

jobs:
  discover-services:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.find.outputs.services }}
      main_service: ${{ steps.find.outputs.main_service }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Discover Dockerfiles & Determine Main Service
        id: find
        run: |
          # Find all service directories containing Dockerfile (exclude root if only for multi-stage)
          SERVICES=$(find . -name Dockerfile -type f | sed 's|/Dockerfile||' | sed 's|^\./||' | grep -v '^$' | sort)
          
          # Always prefer 'web' as main service if it exists
          MAIN_SERVICE=""
          if echo "$SERVICES" | grep -q "^.$"; then
            MAIN_SERVICE="."
          elif echo "$SERVICES" | grep -q "^web$"; then
            MAIN_SERVICE="web"
          elif echo "$SERVICES" | grep -q "^api$"; then
            MAIN_SERVICE="api"
          elif [ -n "$SERVICES" ]; then
            MAIN_SERVICE=$(echo "$SERVICES" | head -n1)
          fi

          SERVICES_JSON=$(echo "$SERVICES" | jq -R -s -c 'split("\n") | map(select(length > 0))')

          echo "services=$SERVICES_JSON" >> $GITHUB_OUTPUT
          echo "main_service=$MAIN_SERVICE" >> $GITHUB_OUTPUT
          echo "Found services: $SERVICES_JSON"
          echo "Main exposed service: $MAIN_SERVICE"

  set-env:
    runs-on: ubuntu-latest
    needs: discover-services
    outputs:
      repo_name: ${{ steps.set.outputs.repo_name }}
      repo_network: ${{ steps.set.outputs.repo_network }}
      gh_actor: ${{ steps.set.outputs.gh_actor }}
      services: ${{ needs.discover-services.outputs.services }}
      main_service: ${{ needs.discover-services.outputs.main_service }}
    steps:
      - uses: actions/checkout@v4
      - id: set
        run: |
          REPO_NAME=${GITHUB_REPOSITORY##*/}
          echo "repo_name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "repo_network=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "gh_actor=${GITHUB_ACTOR}" >> $GITHUB_OUTPUT

  build-and-push:
    needs: [discover-services, set-env]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.discover-services.outputs.services) }}
    env:
      REPO_NAME: ${{ needs.set-env.outputs.repo_name }}
      GH_ACTOR: ${{ needs.set-env.outputs.gh_actor }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ env.GH_ACTOR }}
          password: ${{ secrets.GH_TOKEN }}

      - name: Build and Push ${{ matrix.service }}
        run: |
          SERVICE="${{ matrix.service }}"
          if [ "$SERVICE" = "." ]; then
            IMAGE_NAME="ghcr.io/${{ github.repository }}:latest"
          else
            IMAGE_NAME="ghcr.io/${{ github.repository }}-${SERVICE}:latest"
          fi

          echo "Building $SERVICE → $IMAGE_NAME"
          docker build -t "$IMAGE_NAME" "./$SERVICE"

          echo "Pushing $IMAGE_NAME"
          docker push "$IMAGE_NAME"

          echo "SERVICE_${SERVICE}_IMAGE=$IMAGE_NAME" >> $GITHUB_ENV

  deploy:
    needs: [discover-services, set-env, build-and-push]
    runs-on: ubuntu-latest
    env:
      REPO_NAME: ${{ needs.set-env.outputs.repo_name }}
      REPO_NETWORK: ${{ needs.set-env.outputs.repo_network }}
      MAIN_SERVICE: ${{ needs.discover-services.outputs.main_service }}
      SERVICES_JSON: ${{ needs.discover-services.outputs.services }}

    steps:
      - name: Ensure Docker Networks Exist
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HST }}
          username: ${{ secrets.SSH_USR }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PRT }}
          envs: REPO_NETWORK
          script: |
            if ! docker network ls --format "{{.Name}}" | grep -q "^barcelos\.dev$"; then
              echo "Creating network: barcelos.dev"
              docker network create barcelos.dev
            fi
            if ! docker network ls --format "{{.Name}}" | grep -q "^${REPO_NETWORK}$"; then
              echo "Creating network: ${REPO_NETWORK}"
              docker network create ${REPO_NETWORK}
            fi

      - name: Save Current Images for Rollback
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HST }}
          username: ${{ secrets.SSH_USR }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PRT }}
          envs: REPO_NAME
          script: |
            echo "Saving current images for rollback..."
            > /tmp/rollback_${REPO_NAME}.env
            for container in $(docker ps -a --filter "name=${REPO_NAME}" --format "{{.Names}}"); do
              image=$(docker inspect --format='{{.Image}}' "$container" 2>/dev/null || echo "")
              if [ -n "$image" ]; then
                echo "$container=$image" >> /tmp/rollback_${REPO_NAME}.env
                echo "Saved: $container → $image"
              fi
            done

      - name: Deploy All Services
        id: deploy
        uses: appleboy/ssh-action@v0.1.10
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          SERVICES_JSON: ${{ needs.discover-services.outputs.services }}
          REPO_NAME: ${{ needs.set-env.outputs.repo_name }}
          MAIN_SERVICE: ${{ needs.discover-services.outputs.main_service }}
        with:
          host: ${{ secrets.SSH_HST }}
          username: ${{ secrets.SSH_USR }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PRT }}
          envs: GH_TOKEN, SERVICES_JSON, REPO_NAME, MAIN_SERVICE
          script: |
            echo "$GH_TOKEN" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            SERVICES=($(echo "$SERVICES_JSON" | jq -r '.[]'))

            echo "Stopping old containers..."
            
            echo "Stopping only relevant containers..."
            for service in "${SERVICES[@]}"; do
              if [ $service = "." ]; then
                NAME="${REPO_NAME}"
              else
                NAME="${REPO_NAME}-${service}"
              fi
              
              echo "Checking $NAME..."

              if docker ps -a --format "{{.Names}}" | grep -q "^${NAME}$"; then
                echo "Stopping $NAME"
                docker stop "$NAME" || true
                docker rm "$NAME" || true
              else
                echo "$NAME not running."
              fi
            done

            echo "Starting new containers..."
            for service in "${SERVICES[@]}"; do

              if [ $service = "." ]; then
                IMAGE="ghcr.io/${{ github.repository }}:latest"
                CONTAINER_NAME="$REPO_NAME"
              else
                IMAGE="ghcr.io/${{ github.repository }}-$service:latest"
                CONTAINER_NAME="$REPO_NAME-$service"
              fi

              echo "Pulling $IMAGE"
              docker pull "$IMAGE"

              CMD="docker run -d --name $CONTAINER_NAME --restart unless-stopped"

              # All services on internal network
              CMD="$CMD --network $REPO_NAME"

              # Give API a stable hostname for Nginx
              if [ "$service" = "api" ]; then
                CMD="$CMD --network-alias api"
              fi

              # Only the web container is exposed publicly
              if [ "$service" = "$MAIN_SERVICE" ]; then
                CMD="$CMD --network barcelos.dev"
                CMD="$CMD --network-alias $REPO_NAME"
                CMD="$CMD -v /home/${{ secrets.SSH_USR }}/$REPO_NAME/logs/nginx:/var/log/nginx"
              fi

              CMD="$CMD $IMAGE"
              echo "Running: $CMD"
              eval "$CMD" || echo "Failed to start $CONTAINER_NAME"
            done

            echo "Waiting for containers to stabilize..."
            sleep 15

            # Final check
            FAILED=false
            for service in "${SERVICES[@]}"; do


              if [ $service = "." ]; then
                if ! docker ps --filter "name=$REPO_NAME" --filter "status=running" --format "{{.Names}}" | grep -q .; then
                  echo "$REPO_NAME failed to start"
                  FAILED=true
                else
                  echo "$REPO_NAME is running"
                fi
              else
                if ! docker ps --filter "name=$REPO_NAME-$service" --filter "status=running" --format "{{.Names}}" | grep -q .; then
                  echo "$REPO_NAME-$service failed to start"
                  FAILED=true
                else
                  echo "$REPO_NAME-$service is running"
                fi
              fi

            done

            if [ "$FAILED" = "true" ]; then
              echo "Deployment failed!"
              exit 1
            else
              echo "Deployment successful!"
              sudo systemctl restart nginx
            fi

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HST }}
          username: ${{ secrets.SSH_USR }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PRT }}
          envs: REPO_NAME
          script: |
            echo "ROLLING BACK..."
            if [ ! -f /tmp/rollback_${REPO_NAME}.env ]; then
              echo "No rollback info found!"
              exit 1
            fi

            docker ps -a --filter "name=${REPO_NAME}" --format "{{.Names}}" | xargs -r docker stop
            docker ps -a --filter "name=${REPO_NAME}" --format "{{.Names}}" | xargs -r docker rm

            while IFS='=' read -r name image; do
              [[ -z "$name" || -z "$image" ]] && continue
              echo "Restoring $name from $image"
              docker run -d --name "$name" --restart unless-stopped \
                --network $REPO_NAME \
                $(echo "$name" | grep -q "$MAIN_SERVICE" && echo "--network barcelos.dev -p 80:80") \
                "$image" || true
            done < /tmp/rollback_${REPO_NAME}.env

            sudo systemctl restart nginx
            echo "Rollback completed."