# ===============================
# GitHub Secrets necessários:
# ===============================
# TOKEN: Token de acesso ao registry (GHCR ou Docker Hub)
# SERVER_USER: Usuário SSH do servidor de deploy
# SSH_KEY: Chave privada SSH para conectar no servidor
# SSH_PORT: Porta SSH do servidor (geralmente 22)
# HOST: Endereço IP ou hostname do servidor
#
# Variáveis de ambiente usadas:
# REGISTRY: Registro de container (ghcr.io ou docker.io)
# IMAGE_NAME: Nome da imagem Docker (usualmente o nome do repositório)
# CONTAINER_NAME: Nome do container no servidor
# NETWORK_NAME: Nome da rede Docker que o container usará
# ===============================

name: Build and Deploy Docker

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.actor }}/$${{ github.event.repository.name }}
  CONTAINER_NAME: breakout-game
  NETWORK_NAME: barcelos.dev

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.TOKEN }}

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .

      - name: Push Docker image
        run: |
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Deploy via SSH with rollback
        uses: appleboy/ssh-action@v0.1.9
        env:
          REGISTRY: ${{ env.REGISTRY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
          CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
          NETWORK_NAME: ${{ env.NETWORK_NAME }}
          TOKEN: ${{ secrets.TOKEN }}
          ACTOR: ${{ github.actor }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: REGISTRY,IMAGE_NAME,CONTAINER_NAME,NETWORK_NAME,ACTOR,TOKEN,SERVER_USER
          script: |
            echo "=== Iniciando deploy ==="

            IMAGE=${REGISTRY}/${IMAGE_NAME}:latest
            LOG_DIR=/home/${SERVER_USER}/${CONTAINER_NAME}/logs/nginx

            mkdir -p $LOG_DIR

            LAST_IMAGE=$(docker inspect --format='{{.Image}}' $CONTAINER_NAME 2>/dev/null || echo "")

            docker login $REGISTRY -u $ACTOR -p $TOKEN
            docker pull $IMAGE

            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true

            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              --network $NETWORK_NAME \
              -v $LOG_DIR:/var/log/nginx \
              $IMAGE

            echo "Aguardando inicialização do container..."
            sleep 5

            RETRY=5
            while [ $RETRY -gt 0 ]; do
              STATUS=$(docker inspect -f '{{.State.Running}}' $CONTAINER_NAME 2>/dev/null || echo "false")
              if [ "$STATUS" = "true" ]; then
                echo "Container iniciado com sucesso."
                sudo systemctl restart nginx || true
                exit 0
              fi
              echo "Tentando novamente... ($RETRY restantes)"
              RETRY=$((RETRY-1))
              sleep 2
            done

            echo "Falha: container não iniciou."
            if [ -n "$LAST_IMAGE" ]; then
              echo "Fazendo rollback..."
              docker stop $CONTAINER_NAME || true
              docker rm $CONTAINER_NAME || true
              docker run -d \
                --name $CONTAINER_NAME \
                --restart unless-stopped \
                --network $NETWORK_NAME \
                -v $LOG_DIR:/var/log/nginx \
                $LAST_IMAGE
              sudo systemctl restart nginx || true
              echo "Rollback concluído."
            else
              echo "Nenhuma imagem anterior encontrada. Deploy abortado."
              exit 1
            fi
