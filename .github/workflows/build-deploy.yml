name: Build and Deploy Docker

on:
  push:
    branches:
      - main 

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.TOKEN }}

      - name: Build Docker image
        run: |
          docker build -t ghcr.io/allanbarcelos/breakout-game:latest .

      - name: Push Docker image
        run: |
          docker push ghcr.io/allanbarcelos/breakout-game:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Deploy via SSH with rollback
        uses: appleboy/ssh-action@v0.1.9
        env:
          TOKEN: ${{ secrets.TOKEN }}
          ACTOR: ${{ github.actor }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          envs: ACTOR,TOKEN,SERVER_USER
          script: |
            CONTAINER_NAME=breakout-game
            IMAGE_NAME=ghcr.io/allanbarcelos/breakout-game:latest

            # Salva a última imagem em execução (rollback)
            LAST_IMAGE=$(docker inspect --format='{{.Image}}' $CONTAINER_NAME 2>/dev/null || echo "")

            # Login no Docker Hub
            docker login ghcr.io -u $ACTOR -p $TOKEN

            # Puxa a nova imagem
            docker pull $IMAGE_NAME

            # Para e remove o container antigo
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true

            # Roda a nova imagem
            docker run -d \
              --name $CONTAINER_NAME \
              --restart unless-stopped \
              --network barcelos.dev \
              $IMAGE_NAME

            # Espera iniciar
            echo "Aguardando container iniciar..."
            sleep 5

            # Retry para verificar se o container está rodando
            RETRY=5
            while [ $RETRY -gt 0 ]; do
              CONTAINER_STATUS=$(docker inspect -f '{{.State.Running}}' $CONTAINER_NAME 2>/dev/null || echo "false")
              if [ "$CONTAINER_STATUS" = "true" ]; then
                echo "Container iniciado com sucesso."
                sudo systemctl restart nginx
                exit 0
              fi
              echo "Container ainda não iniciou. Tentativas restantes: $RETRY"
              RETRY=$((RETRY-1))
              sleep 2
            done

            # Se chegou aqui, o container não iniciou
            echo "Falha: o container não está rodando."
            if [ -n "$LAST_IMAGE" ]; then
              echo "Fazendo rollback para a última imagem..."
              docker stop $CONTAINER_NAME || true
              docker rm $CONTAINER_NAME || true
              docker run -d \
                --name $CONTAINER_NAME \
                --restart unless-stopped \
                --network barcelos.dev \
                $LAST_IMAGE
              sudo systemctl restart nginx
              echo "Rollback concluído."
            else
              echo "Nenhuma imagem anterior encontrada. Deploy falhou."
              exit 1
            fi